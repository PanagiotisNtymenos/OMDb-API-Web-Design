<!DOCTYPE html>
<html>

<head>
	<meta charset="UTF-8">
	<meta name="viewport" content="width=device-width, initial-scale=1.0">
	<link rel="stylesheet" type="text/css" href="resources/static/css/styles.css">
	<link rel="icon" href="resources/static/images/iconcircle.png">
	<script src="http://ajax.googleapis.com/ajax/libs/jquery/1.7.1/jquery.min.js" type="text/javascript"></script>

	<script>
		var movieID;

		function OMDbAPICall(title) {
			$.getJSON('http://www.omdbapi.com/?apikey=274dad1c&s=' + encodeURI(title))
				.then(
					function (result) {

						var rawString = JSON.stringify(result);
						var response = JSON.parse(rawString);

						if (response.Search == null) {
							if (!$("#searchBar").val()) {
								document.querySelector("#notFound").style.opacity = "0";
							} else {
								document.querySelector("#notFound").style.opacity = "1";
								document.querySelector("#notFound").innerHTML = "No result :(";
							}
							document.querySelector("#results").style.display = "none";
						}

						if (response.Search != null) {
							for (i = 0; i < response.Search.length; i++) {
								result = response.Search[i];
								movieID = result.imdbID;


								var resultToAdd = '<div id="preview' + movieID + '" style="overflow: hidden;"><div><img id="src' + movieID + '" src="resources/static/images/404.png" style="width: 40%;height: auto;padding-right: 20px;float: left;" alt="Poster" class="responsive"></div><div style="white-space: normal;" id="info' + movieID + '"><h3>Title: <span class="res" style="white-space: normal;" id="title' + movieID + '"></span></h3><h4>Released: <span class="res" id="release' + movieID + '"></span></h4><br><div id="sl"><a id="show' + movieID + '" href="#!" onClick="showInfo(' + "'" + movieID + "'" + ')"style="font-size: small; white-space: nowrap;">More Information</a> <br> <br>	</div><div><a id="bookmark_save' + movieID + '" href="#!" onClick="bookmark(' + "'" + movieID + "'" + '); saveBookmark(' + "'" + movieID + "'" + ');"><strong>Add to Bookmarks !</strong></a></div></div></div>';
								var infoToAdd = '<span class="clear"><div id="moreinf' + movieID + '" style="display: none;"><h3>More Information</h3><h4>Genre: <span class="res" id="genre' + movieID + '"></span></h4><h4>Rating: <span class="res" id="imdbRating' + movieID + '"></span></h4><h4>Plot: <span class="res" id="plot' + movieID + '"></span></h4><h4>Rated: <span class="res" id="rated' + movieID + '"></span></h4><h4>Duration: <span class="res" id="runtime' + movieID + '"></span></h4><h4>Director: <span class="res" id="director' + movieID + '"></span></h4><h4>Writer: <span class="res" id="writer' + movieID + '"></span></h4><h4>Actors: <span class="res" id="actors' + movieID + '"></span></h4><h4>Awards: <span class="res" id="awards' + movieID + '"></span></h4><h4>Language: <span class="res" id="language' + movieID + '"></span></h4><h4>Production: <span class="res" id="production' + movieID + '"></span></h4></div></span>';

								document.getElementById("movies").innerHTML = document.getElementById("movies").innerHTML + resultToAdd + infoToAdd + "<br><br> <br><br>";


								var poster = result.Poster;
								var title = result.Title;
								var release = result.Year;
								if (poster !== "N/A") {
									$('#src' + movieID).attr('src', poster);
								} else {
									$('#src' + movieID).attr('src', "resources/static/images/404v2.png");
								}
								document.querySelector("#notFound").innerHTML = "Result...";
								document.querySelector("#notFound").style.opacity = "1";
								document.querySelector("#results").style.display = "block";
								document.querySelector("#title" + movieID).innerHTML = title;
								document.querySelector("#release" + movieID).innerHTML = release;
							}


							if (document.getElementById("user_name").textContent != "Guest" && movieID != null) {
								$.ajax({
									type: "GET",
									url: "bookmark",
									dataType: "text",
									data: {
										username: document.getElementById("user_name").textContent
									},
									error: function (bookmarksList) {

									},
									success: function (bookmarksList) {
										var moviesList = bookmarksList.split(" #NEXT# ");
										for (i = 0; i < response.Search.length; i++) {
											result = response.Search[i];
											movieID = result.imdbID;
											console.log(response)
											console.log(result.Title)
											if (moviesList.includes(movieID)) {
												document.getElementById("bookmark_save" + movieID).innerHTML = "<strong>Delete from Bookmarks !</strong>";
											} else {
												document.getElementById("bookmark_save" + movieID).innerHTML = "<strong>Add to Bookmarks !</strong>";
											}
										}
									}
								});
							}

						}
					});

		}

		$(document).ready(function () {
			$("#searchBar").keyup(function (e) {
				document.getElementById("movies").innerHTML = "";
				OMDbAPICall($("#searchBar").val());

			});
		});

		function bookmark(id) {

			if (document.getElementById("user_name").textContent != "Guest") {
				if ((document.getElementById("bookmark_save" + id).textContent == 'Add to Bookmarks !')) {
					document.getElementById("bookmark_save" + id).innerHTML = "<strong>Delete from Bookmarks !</strong>";
					document.getElementById("bookmark_save" + id).style.color = "#931f1f";
				} else {
					document.getElementById("bookmark_save" + id).innerHTML = "<strong>Add to Bookmarks !</strong>";
					document.getElementById("bookmark_save" + id).style.color = "black";
				}
			}
		}

		function showInfo(id) {

			if (document.querySelector("#moreinf" + id).style.display == "inline-block") {
				document.querySelector("#moreinf" + id).style.display = "none";
				document.querySelector("#show" + id).innerHTML = "More Information";
			} else {
				document.querySelector("#moreinf" + id).style.display = "inline-block";
				document.querySelector("#show" + id).innerHTML = "Less Information";

				$.getJSON('http://www.omdbapi.com/?apikey=274dad1c&i=' + encodeURI(id)).then(function (result) {

					var response = result.Response;
					var poster = result.Poster;
					var title = result.Title;
					var release = result.Year;
					var genre = result.Genre;
					var score = result.imdbRating;
					if (response == "False") {
						if (!$("#searchBar").val()) {
							document.querySelector("#notFound").style.opacity = "0";
						} else {
							document.querySelector("#notFound").style.opacity = "1";
							document.querySelector("#notFound").innerHTML = "No result :(";
						}
						document.querySelector("#results").style.display = "none";
					} else {
						if (poster !== "N/A") {
							$('#src' + id).attr('src', poster);
						} else {
							$('#src' + id).attr('src', "resources/static/images/404v2.png");
						}

						var plot = result.Plot;
						var rated = result.Rated;
						var duration = result.Runtime;
						var director = result.Director;
						var writer = result.Writer;
						var actors = result.Actors;
						var awards = result.Awards;
						var language = result.Language;
						var production = result.Production;

						document.querySelector("#genre" + id).innerHTML = genre;
						document.querySelector("#imdbRating" + id).innerHTML = score;
						document.querySelector("#plot" + id).innerHTML = plot;
						document.querySelector("#rated" + id).innerHTML = rated;
						document.querySelector("#runtime" + id).innerHTML = duration;
						document.querySelector("#director" + id).innerHTML = director;
						document.querySelector("#writer" + id).innerHTML = writer;
						document.querySelector("#actors" + id).innerHTML = actors;
						document.querySelector("#awards" + id).innerHTML = awards;
						document.querySelector("#language" + id).innerHTML = language;
						document.querySelector("#production" + id).innerHTML = production;
					}
				});

			}

		}

		function logInPopUp(TODO) {
			if (TODO == 'login') {
				if (document.getElementById("login_say").textContent != "Logout") {
					document.querySelector(".login-popup").style.display = "flex";
				} else {
					callLogin();
				}
			} else if (TODO == 'cancel') {
				document.querySelector(".login-popup").style.display = "none";
			}
		}

		function signUpPopUp(TODO) {
			if (TODO == 'signup') {
				if (document.getElementById("register_say").textContent != "Bookmarks") {
					document.querySelector(".signup-popup").style.display = "flex";
				} else {
					callBookmarks(document.getElementById("user_name").textContent);
				}
			} else if (TODO == 'cancel') {
				document.querySelector(".signup-popup").style.display = "none";
			}
		}

		function callLogin() {

			if (document.getElementById("login_say").textContent == "Logout") {
				$.ajax({
					type: "POST",
					url: "logout",
					dataType: "text",
					error: function (response) {

					},
					success: function (response) {
						document.getElementById("user_name").innerHTML = "Guest";
						document.getElementById("login_say").innerHTML = "Login";
						document.getElementById("register_say").innerHTML = "Register";
						location.reload();
					}
				});
			} else {
				$.ajax({
					type: "POST",
					url: "login",
					data: {
						email: document.getElementById("login_email").value,
						password: document
							.getElementById("login_password").value
					},
					dataType: "text",
					error: function (response) {

					},
					success: function (response) {
						document.getElementById("user_name").innerHTML = response;
						if (response == "Guest") {
							document.getElementById("login_say").innerHTML = "Login";
							document.getElementById("register_say").innerHTML = "Register";
							alert('WRONG CREDENTIALS!!!\nOK! So...you pressed something wrong and you might have destroyed a whole country!\nNext time, enter CORRECT credentials!\nTry again..');
						} else {
							document.getElementById("login_say").innerHTML = "Logout";
							document.getElementById("register_say").innerHTML = "Bookmarks";
							logInPopUp('cancel');
							location.reload();
						}

					}
				});
			}
		}

		function callSignup() {
			if (document.getElementById("register_say").textContent == "Register") {
				$.ajax({
					type: "POST",
					url: "register",
					data: {
						email: document.getElementById("register_email").value,
						username: document
							.getElementById("register_username").value,
						f_password: document
							.getElementById("first_password").value,
						s_password: document
							.getElementById("second_password").value
					},
					dataType: "text",
					error: function (response) {

					},
					success: function (response) {
						if (response == "EmailUsed") {
							alert('This E-mail address is already in use!');
						} else if (response == "Password") {
							alert('Please enter the same password in both fields!');
						} else if (response == "Guest") {
							alert('This username is already in use!');
						} else if (response == "Missing") {
							signUpPopUp('cancel');
						} else {

							$.ajax({
								type: "POST",
								url: "login",
								data: {
									email: document
										.getElementById("register_email").value,
									password: document
										.getElementById("first_password").value
								},
								dataType: "text",
								error: function (response) {

								},
								success: function (response) {
									document
										.getElementById("user_name").innerHTML = response;

									document
										.getElementById("login_say").innerHTML = "Logout";
									document
										.getElementById("register_say").innerHTML = "Bookmarks";
									logInPopUp('cancel');
									location.reload();
								}
							});

							signUpPopUp('cancel');
						}

					}
				});

			}
		}

		function callBookmarks(user) {
			location.replace("bookmarks.html");
		}

		function saveBookmark(movieID) {

			if (document.getElementById("user_name").textContent == "Guest") {
				logInPopUp('login');
			} else {
				$.ajax({
					type: "POST",
					url: "save",
					dataType: "text",
					data: {
						username: document.getElementById("user_name").textContent,
						movieTitle: movieID
					},
					error: function (response) {

					},
					success: function (response) {

					}
				});
			}
		}

		function initialize() {
			document.getElementById("movies").innerHTML = "";
			$.ajax({
				type: "POST",
				url: "init_login",
				dataType: "text",
				error: function (response) {

				},
				success: function (response) {
					document.getElementById("login_say").innerHTML = response;
				}
			});
			$.ajax({
				type: "POST",
				url: "init_register",
				dataType: "text",
				error: function (response) {

				},
				success: function (response) {
					document.getElementById("register_say").innerHTML = response;
				}
			});
			$.ajax({
				type: "POST",
				url: "init_user",
				dataType: "text",
				error: function (response) {

				},
				success: function (response) {
					document.getElementById("user_name").innerHTML = response;
				}
			});

		}
	</script>
	<title>OMDb</title>

</head>

<body onLoad="initialize()">

	<div id="myBody">
		<div class="grid-flex">
			<header>
				<h1 class="item11" style="text-align: center;">
					OMD<span style="color: #931f1f">b</span>
				</h1>
			</header>

			<main>

				<div id="menu" class="item22" style="overflow: hidden;">
					<a id="login_say" href="#!" onClick="logInPopUp('login')">Login</a>
					<a id="register_say" href="#!" onClick="signUpPopUp('signup')">Register</a>
					<span id="loginas">Connected as, <span id="user_name" style="color: #931f1f">Guest</span>
					</span>
				</div>

				<div class="center">
					<div class="inner item33">
						<input id="searchBar" style="font-family: CaviarDreams;" type="search" name="search"
							placeholder="Search..">
					</div>
					<div style="text-align: center;">
						<p id="notFound">No result :(</p>
					</div>
				</div>
				<div id="results" class="item44" style="margin-top: 20px;">
					<div class="container">
						<div style="margin: auto;">
							<div id="movies" style="overflow: hidden;">
								<div id="preview" style="overflow: hidden;">
									<div>
										<img id="src" src="resources/static/images/404.png" alt="Poster"
											class="responsive">
									</div>

									<div id="info">

										<h3>
											Title: <span class="res" id="title"></span>
										</h3>
										<h4>
											Released: <span class="res" id="release"></span>
										</h4>
										<h4>
											Genre: <span class="res" id="genre"></span>
										</h4>
										<h4>
											Rating: <span class="res" id="imdbRating"></span>
										</h4>
										<br>
										<div id="sl">
											<a id="show" href="#" onClick="showInfo()"
												style="font-size: small; white-space: nowrap;">More
												Information</a> <br> <br>
										</div>
										<div>
											<a id="bookmark_save" href="#"
												onClick="bookmark(); saveBookmark();"><strong>Save
													!</strong></a>
										</div>
									</div>

								</div>

								<div class="clear">
									<div id="moreinf">
										<h3>More Information</h3>

										<h4>
											Plot: <span class="res" id="plot"></span>
										</h4>
										<h4>
											Rated: <span class="res" id="rated"></span>
										</h4>
										<h4>
											Duration: <span class="res" id="runtime"></span>
										</h4>
										<h4>
											Director: <span class="res" id="director"></span>
										</h4>
										<h4>
											Writer: <span class="res" id="writer"></span>
										</h4>
										<h4>
											Actors: <span class="res" id="actors"></span>
										</h4>
										<h4>
											Awards: <span class="res" id="awards"></span>
										</h4>
										<h4>
											Language: <span class="res" id="language"></span>
										</h4>
										<h4>
											Production: <span class="res" id="production"></span>
										</h4>
									</div>
								</div>
							</div>
						</div>
					</div>
				</div>

				<div class="login-popup">
					<div class="popup-content">
						<img src="resources/static/images/cancelred.png" onClick="logInPopUp('cancel')" width="20px" height="20px"
							alt="Cancel" class="cancel">
						<p style="font-size: large;">Login!</p>
						<form action="">
							<input id="login_email" type="email" placeholder="E-mail">
							<input id="login_password" type="password" placeholder="Password"><br>
							<a id="loginGO" href="#" class="button" onClick="callLogin()"
								style="font-size: 20px;"><strong>Login</strong></a><br> <br>
						</form>
						<p style="font-size: 12px;">
							You don't have an account yet? <a href="#"
								onClick="signUpPopUp('signup'); logInPopUp('cancel');" style="font-size: 15px;">
								Register!</a>
						</p>
						<br>
					</div>
				</div>

				<div class="signup-popup">
					<div class="popup-content">
						<img src="resources/static/images/cancelred.png" onClick="signUpPopUp('cancel')" width="20px" height="20px"
							alt="Cancel" class="cancel">
						<p style="font-size: large;">Register!</p>
						<br>
						<form action="">
							<input id="register_username" type="text" placeholder="Username">
							<input id="register_email" type="email" placeholder="E-mail">
							<input id="first_password" type="password" placeholder="Password">
							<input id="second_password" type="password" placeholder="Confirm password"><br> <a href="#"
								onClick="callSignup();" style="font-size: 20px;"><strong>Register</strong></a><br>
							<br>
						</form>
						<p style="font-size: 12px;">
							You already have an account? <a href="#"
								onClick="logInPopUp('login'); signUpPopUp('cancel');" style="font-size: 15px;">
								Login!</a>
						</p>
						<br>
					</div>
				</div>

			</main>
		</div>
		<br> <br> <br>
		<footer>
			<p id="foot" style="text-align: center;">Panayots 2020 &#169;</p>
		</footer>
	</div>
</body>

</html>